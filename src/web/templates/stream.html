<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumi AI - Stream Overlay</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            color: white;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        
        .stream-overlay {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 20px;
            background: linear-gradient(transparent 60%, rgba(0,0,0,0.7) 100%);
        }
        
        .live2d-container {
            position: absolute;
            bottom: 120px;
            right: 20px;
            width: 200px;
            height: 150px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
            overflow: hidden;
        }
        
        #live2d-frame {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #live2d-frame img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }
        
        .chat-container {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .chat-container::-webkit-scrollbar {
            width: 5px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
        }
        
        .message {
            margin-bottom: 8px;
            animation: slideIn 0.3s ease-out;
            background: rgba(0,0,0,0.6);
            padding: 8px 12px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            border-left: 3px solid #4facfe;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .user-message {
            border-left-color: #00f2fe;
        }
        
        .ai-message {
            border-left-color: #4facfe;
        }
        
        .message-sender {
            font-weight: bold;
            margin-bottom: 2px;
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .message-text {
            font-size: 0.95em;
            line-height: 1.3;
        }
        
        .emotion-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .typing-indicator {
            display: none;
            background: rgba(0,0,0,0.6);
            padding: 8px 12px;
            border-radius: 8px;
            font-style: italic;
            margin-bottom: 8px;
            backdrop-filter: blur(10px);
            border-left: 3px solid #ffd700;
        }
        
        /* Fade out old messages */
        .message.fade-out {
            opacity: 0.3;
            transform: scale(0.95);
            transition: all 0.5s ease-in;
        }
    </style>
</head>
<body>
    <div class="stream-overlay">
        <div class="emotion-display" id="emotion-display">
            Mood: <span id="current-emotion">neutral</span>
        </div>
        
        <div class="live2d-container">
            <div id="live2d-frame">
                <div style="color: white; text-align: center; font-size: 0.8em;">
                    Live2D Model
                </div>
            </div>
        </div>
        
        <div class="chat-container" id="chat-container">
            <div class="message ai-message">
                <div class="message-sender">Lumi</div>
                <div class="message-text">Hello! I'm ready for the stream! ðŸŽ®</div>
            </div>
        </div>
        
        <div class="typing-indicator" id="typing-indicator">
            Lumi is typing...
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        class StreamOverlay {
            constructor() {
                this.socket = io();
                this.maxMessages = 5; // Keep only latest messages
                this.setupSocketHandlers();
                this.startLive2D();
            }
            
            setupSocketHandlers() {
                this.socket.on('connected', (data) => {
                    console.log('Connected to stream overlay');
                });
                
                this.socket.on('chat_response', (data) => {
                    this.hideTyping();
                    this.addMessage(data.response, 'ai', 'Lumi');
                    
                    // Auto-remove old messages after delay
                    setTimeout(() => this.cleanupOldMessages(), 5000);
                });
                
                this.socket.on('live2d_frame', (data) => {
                    this.updateLive2DFrame(data.frame);
                });
                
                this.socket.on('emotion_updated', (data) => {
                    this.updateEmotionDisplay(data.emotion);
                });
                
                this.socket.on('chat_message', (data) => {
                    // For testing - simulate user messages
                    // In production, this would come from your chat system
                });
            }
            
            startLive2D() {
                this.socket.emit('start_live2d_stream');
            }
            
            addMessage(text, type, sender = 'User') {
                const chatContainer = document.getElementById('chat-container');
                
                // Create message element
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}-message`;
                
                const senderDiv = document.createElement('div');
                senderDiv.className = 'message-sender';
                senderDiv.textContent = sender;
                
                const textDiv = document.createElement('div');
                textDiv.className = 'message-text';
                textDiv.textContent = text;
                
                messageDiv.appendChild(senderDiv);
                messageDiv.appendChild(textDiv);
                
                // Add to container
                chatContainer.appendChild(messageDiv);
                
                // Limit number of messages
                this.limitMessages();
                
                // Auto-scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            limitMessages() {
                const chatContainer = document.getElementById('chat-container');
                const messages = chatContainer.getElementsByClassName('message');
                
                if (messages.length > this.maxMessages) {
                    // Fade out and remove oldest message
                    const oldestMessage = messages[0];
                    oldestMessage.classList.add('fade-out');
                    
                    setTimeout(() => {
                        if (oldestMessage.parentNode) {
                            oldestMessage.parentNode.removeChild(oldestMessage);
                        }
                    }, 500);
                }
            }
            
            cleanupOldMessages() {
                const chatContainer = document.getElementById('chat-container');
                const messages = chatContainer.getElementsByClassName('message');
                
                // Remove messages that are older than max count
                while (messages.length > this.maxMessages) {
                    messages[0].parentNode.removeChild(messages[0]);
                }
            }
            
            showTyping() {
                document.getElementById('typing-indicator').style.display = 'block';
            }
            
            hideTyping() {
                document.getElementById('typing-indicator').style.display = 'none';
            }
            
            updateLive2DFrame(frameData) {
                const live2dFrame = document.getElementById('live2d-frame');
                live2dFrame.innerHTML = `<img src="${frameData}" alt="Live2D Model">`;
            }
            
            updateEmotionDisplay(emotion) {
                document.getElementById('current-emotion').textContent = emotion;
                
                // Update emotion display color based on emotion
                const emotionDisplay = document.getElementById('emotion-display');
                const emotionColors = {
                    'happy': '#4CAF50',
                    'sad': '#2196F3',
                    'angry': '#f44336',
                    'excited': '#FF9800',
                    'curious': '#9C27B0',
                    'neutral': '#607D8B'
                };
                
                emotionDisplay.style.borderLeftColor = emotionColors[emotion] || '#607D8B';
            }
            
            // Method to simulate chat for testing
            simulateChat() {
                const testMessages = [
                    "Hey Lumi, how's the stream going?",
                    "Can you tell us a fun fact?",
                    "What games do you like?",
                    "You're doing great!",
                    "How are you feeling today?"
                ];
                
                const randomMessage = testMessages[Math.floor(Math.random() * testMessages.length)];
                this.addMessage(randomMessage, 'user', 'Viewer');
                
                this.showTyping();
                
                // Simulate AI response after delay
                setTimeout(() => {
                    this.socket.emit('chat_message', { message: randomMessage });
                }, 2000);
            }
        }
        
        // Initialize overlay
        document.addEventListener('DOMContentLoaded', () => {
            window.streamOverlay = new StreamOverlay();
            
            // Auto-simulate chat for testing (remove in production)
            setInterval(() => {
                if (Math.random() < 0.3) { // 30% chance every 10 seconds
                    window.streamOverlay.simulateChat();
                }
            }, 10000);
        });
    </script>
</body>
</html>